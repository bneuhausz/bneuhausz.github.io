<script lang="ts">
  import { injectContentFiles } from '@analogjs/content';
  import BlogCard from './blog-card.analog' with { analog: 'imports' };
  import PostAttributes from '../../post-attributes';
  import { computed, signal } from '@angular/core';
  import { RouteMeta } from '@analogjs/router';
  import { DatePipe } from '@angular/common' with { analog: 'imports' };
  import { FormsModule } from '@angular/forms' with { analog: 'imports' };
  import { RouterLink } from '@angular/router' with { analog: 'imports' };

  export const routeMeta: RouteMeta = {
    title: 'Blog - bneuhausz.dev',
  };

  const posts = signal(injectContentFiles<PostAttributes>(post => !post.attributes.draft));
  const selectedTag = signal('');
  const selectedSort = signal('desc');

  const uniqueTags = computed(() => {
    const allTags = posts().flatMap(post => post.attributes.tags);
    const unique = [...new Set(allTags)];
    return unique.sort();
  });

  const sortedPosts = computed(() => {
    return [...posts()].sort((a, b) => {
      const dateA = new Date(a.attributes.date);
      const dateB = new Date(b.attributes.date);

      if (dateB.getTime() !== dateA.getTime()) {
        return dateB.getTime() - dateA.getTime();
      }

      return 0;
    });
  });

  const featuredPosts = computed(() => {
    return sortedPosts().slice(0, 3);
  });

  const filteredPosts = computed(() => {
    const tag = selectedTag();
    const sort = selectedSort();
    let posts = sort === 'asc' ? [...sortedPosts()].reverse() : sortedPosts();

    if (tag) {
      posts = posts.filter(post => post.attributes.tags.includes(tag));
    }
    return posts;
  });
</script>

<template>
  <h1>
    Some of my thoughts are documented here
  </h1>

  <section class="grid gap-8 grid-cols-[repeat(auto-fit,minmax(400px,1fr))] place-items-center py-5">
    @for (post of featuredPosts(); track post.attributes.slug) {
      <BlogCard [post]="post" />
    }
  </section>

  <section class="w-3/5 mx-auto my-5">
    <div class="flex justify-center mb-4 gap-4">
      <select class="select bg-amber-100 text-amber-900" [(ngModel)]="selectedTag">
        <option value="">All Tags</option>
        @for (tag of uniqueTags(); track tag) {
          <option value="{{ tag }}">{{ tag }}</option>
        }
      </select>
  
      <select class="select bg-amber-100 text-amber-900" [(ngModel)]="selectedSort">
        <option value="desc">Newest first</option>
        <option value="asc">Oldest first</option>
      </select>
    </div>

    @for (post of filteredPosts(); track post.attributes.slug) {
      <ul class="list bg-neutral rounded-box shadow-md">    
        <li class="list-row pb-4 border-b border-amber-100 cursor-pointer hover:bg-neutral-900 transition duration-500" [routerLink]="['/blog', post.attributes.slug]">
          <div><img class="size-10 rounded-box bg-amber-100" src="{{ post.attributes.icon }}" alt="{{ post.attributes.iconDescription }}"/></div>
          <div>
            <div>{{ post.attributes.title }}</div>
            <div class="text-xs uppercase font-semibold opacity-60 mb-1">{{ post.attributes.date | date: 'yyyy-MM-dd' }}</div>
            @for (tag of post.attributes.tags; track tag) {
              <div class="badge bg-amber-100 text-amber-900 mx-1 mb-1 md:mb-0">{{ tag }}</div>
            }
          </div>
          <p class="list-col-wrap text-xs">
            {{ post.attributes.description }}
          </p>
        </li>      
      </ul>
    }
  </section>
</template>